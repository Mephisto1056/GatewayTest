# 🧪 系统测试指南

## 🎯 最新更新
- ✅ **角色选择功能**：可以动态切换高层/中层/基层管理者角色进行测试
- ✅ **姓名可编辑**：支持修改被评估者姓名
- ✅ **自动问卷切换**：角色改变时自动加载对应问卷并清空之前的回答
- ✅ 隐藏问题分类标签和评分数字，界面更简洁
- ✅ 优化表单验证提示，显示具体未完成题目数量
- ✅ 所有题目都是必填项，确保数据完整性

## 📋 测试前准备

### 1. 环境要求
- Node.js (推荐 v18+)
- npm 或 yarn
- 数据库 (MySQL/PostgreSQL)

### 2. 安装依赖
```bash
# 后端依赖
cd backend
npm install

# 前端依赖
cd ../frontend
npm install
```

## 🚀 启动系统

### 方式一：分别启动前后端

#### 启动后端服务
```bash
cd backend

# 开发模式启动
npm run start:dev

# 或者生产模式启动
npm run build
npm run start:prod
```
后端将在 `http://localhost:3000` 启动

#### 启动前端服务
```bash
cd frontend

# 开发模式启动
npm run dev
```
前端将在 `http://localhost:5173` 启动

### 方式二：使用我们的测试脚本

#### 测试评分计算逻辑
```bash
cd backend
npx ts-node src/scripts/test-scoring.ts
```

#### 测试API接口
```bash
cd backend
npx ts-node src/scripts/test-api.ts
```

## 🧪 功能测试步骤

### 1. 基础功能测试

#### 测试问卷获取API
```bash
# 测试获取自主导向问题
curl http://localhost:3000/questionnaires/selfdirected

# 测试获取高层问题
curl http://localhost:3000/questionnaires/highlevel

# 测试根据角色获取问卷
curl "http://localhost:3000/questionnaires/by-role/高层领导者"
```

#### 测试问卷提交API
```bash
curl -X POST http://localhost:3000/evaluations/submit-questionnaire \
  -H "Content-Type: application/json" \
  -d '{
    "evaluationId": 1,
    "respondentId": 1,
    "relationship": "自评",
    "responses": [
      {"questionCode": "SD001", "score": 4},
      {"questionCode": "SD002", "score": 3},
      {"questionCode": "HL001", "openText": "这是开放式回答"}
    ]
  }'
```

### 2. 前端界面测试

#### 访问问卷页面
1. 打开浏览器访问 `http://localhost:5173`
2. 查看问卷组件是否正常加载
3. 测试不同用户角色的问卷展示

#### 测试问卷填写流程
1. **选择测试角色**：在角色下拉框中选择高层/中层/基层管理者
2. **修改姓名**（可选）：在姓名输入框中修改被评估者姓名
3. **选择关系**：选择您与被评估者的关系（上级/平级/下级/自评）
4. **填写问卷**：
   - 自主导向问题（23题，所有角色共同）
   - 角色特定问题（高层40题/中层36题/基层33题）
   - 开放式问题（3题）
5. **查看进度**：实时进度条显示完成情况
6. **提交问卷**：完成所有题目后提交并查看结果

#### 角色切换测试
1. 选择"高层领导者" → 查看问卷题目数量
2. 切换到"中层管理者" → 观察问卷内容变化
3. 切换到"基层管理者" → 验证题目自动更新
4. 注意：角色切换会清空之前的回答

### 3. 评分计算测试

#### 手动验证评分规则
1. **反向计分测试**：
   - 输入原始分数：2
   - 预期结果：4 (6-2=4)

2. **相关性计算测试**：
   - 自主导向得分：4
   - 目标题目得分：3
   - 预期结果：3.4 (4×0.4 + 3×0.6)

3. **360度权重测试**：
   - 上级评分：85，平级评分：80，下级评分：90
   - 高层领导者权重：50%、30%、20%
   - 预期结果：84.5 (85×0.5 + 80×0.3 + 90×0.2)

## 🔧 调试和故障排除

### 常见问题

#### 1. 数据库连接问题
```bash
# 检查数据库配置
cat backend/.env

# 确保数据库服务运行
# MySQL: brew services start mysql
# PostgreSQL: brew services start postgresql
```

#### 2. 端口冲突
```bash
# 查看端口占用
lsof -i :3000
lsof -i :5173

# 杀死占用进程
kill -9 <PID>
```

#### 3. 依赖问题
```bash
# 清理并重新安装
rm -rf node_modules package-lock.json
npm install
```

### 日志查看
```bash
# 后端日志
cd backend
npm run start:dev

# 前端日志
cd frontend
npm run dev
```

## 📊 测试数据准备

### 1. 导入问题数据
```bash
cd backend

# 导入所有问题
npx ts-node src/scripts/import-all-questions.ts

# 或分别导入
npx ts-node src/scripts/import-selfdirected-questions.ts
npx ts-node src/scripts/import-highleveltest-questions.ts
npx ts-node src/scripts/import-mediumleveltest-questions.ts
npx ts-node src/scripts/import-lowleveltest-questions.ts
```

### 2. 验证数据导入
```bash
# 验证数据结构
npx ts-node src/scripts/verify-data-structure.ts
```

## 🎯 完整测试流程

### 端到端测试步骤
1. **启动服务**：同时启动前后端服务
2. **数据准备**：导入问题数据到数据库
3. **API测试**：使用curl或Postman测试所有API接口
4. **界面测试**：在浏览器中测试完整的问卷流程
5. **计算验证**：验证评分计算结果的准确性
6. **结果展示**：测试评估结果页面的显示

### 自动化测试
```bash
# 运行所有测试
cd backend
npm test

# 运行特定测试
npm run test:e2e
```

## 📝 测试检查清单

- [ ] 后端服务正常启动
- [ ] 前端服务正常启动
- [ ] 数据库连接正常
- [ ] 问题数据导入成功
- [ ] 问卷获取API正常
- [ ] 问卷提交API正常
- [ ] 评分计算正确
- [ ] 360度评估权重计算正确
- [ ] 前端问卷界面正常显示
- [ ] 问卷填写流程完整
- [ ] 结果展示页面正常
- [ ] 反向计分功能正确
- [ ] 相关性计算功能正确

## 🆘 获取帮助

如果遇到问题，可以：
1. 查看控制台错误信息
2. 检查网络请求状态
3. 验证数据库数据
4. 运行测试脚本进行诊断

测试愉快！🎉