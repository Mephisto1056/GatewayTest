# 部署说明文档

## 1. 运行环境要求

推荐使用 **Linux** 服务器（如 Ubuntu 20.04/22.04 或 CentOS 7/8）。

### 必须安装的软件
*   **Node.js**: 版本 **v18.x** 或 **v20.x** (LTS版本)。
    *   用于运行后端服务及前端构建。
*   **PostgreSQL**: 版本 **14.x** 或更高。
    *   作为系统的主数据库。
*   **Nginx** (可选，推荐):
    *   用于反向代理后端服务及托管前端静态资源。
*   **PM2** (推荐):
    *   用于 Node.js 后端进程守护 (`npm install -g pm2`)。

### 其它依赖
*   **字体库**: 后端生成 PDF 报告时需要中文字体支持，请确保服务器安装了基础字体库，或者项目部署包中已包含字体文件（本项目 `backend/fonts/SimHei.ttf` 已包含）。

## 2. 数据库要求

*   **数据库类型**: **PostgreSQL**
*   **版本**: 14.0 及以上
*   **配置**:
    *   需要创建一个新的数据库（例如 `gateway_db`）。
    *   需要提供数据库连接信息：主机地址、端口（默认 5432）、用户名、密码。
*   **Redis**: **不需要**。目前系统未使用 Redis 缓存。

## 3. 资源预估

以下配置适用于中小规模（并发用户数 < 100）的部署：

*   **CPU**: 2 Core (建议 4 Core 以保证生成报告时的性能)
*   **内存**: 4 GB (建议 8 GB，Node.js 服务和 PostgreSQL 数据库共享)
*   **磁盘**: 建议 50 GB 以上 SSD (主要用于存储数据库备份及生成的 PDF 报告文件)

## 4. 端口及配置

### 后端服务
*   **运行端口**: **3000** (默认)
    *   可通过环境变量 `PORT` 修改。
*   **环境变量配置** (`.env` 文件):
    *   `DB_HOST`: 数据库地址
    *   `DB_PORT`: 数据库端口 (默认 5432)
    *   `DB_USERNAME`: 数据库用户名
    *   `DB_PASSWORD`: 数据库密码
    *   `DB_DATABASE`: 数据库名称
    *   `JWT_SECRET`: 用于加密 Token 的密钥
    *   `EMAIL_XXX`: 邮件服务配置 (SMTPHost, User, Password 等)

### 前端服务
*   **运行端口**: 80 或 443 (通过 Nginx 托管)
*   **API 转发**: 需要将 `/api` 开头的请求转发到后端服务的 3000 端口。

## 5. 交付方式 (推荐使用 Docker)

我们强烈推荐使用 **Docker 容器化部署**，以确保环境一致性（特别是字体库对 PDF 生成的影响）并简化数据库的安装和维护。

### 方式一：Docker 一键部署 (强烈推荐)

本方案无需手动安装 Node.js、PostgreSQL 和 Nginx，只需服务器安装 Docker 即可。

#### 1. 准备工作
*   服务器安装 **Docker** 和 **Docker Compose**。
*   将项目代码上传至服务器。

#### 2. 部署步骤
在项目根目录下执行以下命令：

```bash
# 1. 构建并启动所有服务（后台运行）
docker-compose up -d --build

# 2. 查看容器运行状态
docker-compose ps

# 3. 查看日志（排查问题时使用）
docker-compose logs -f
```

执行成功后：
*   **前端访问**: `http://101.132.237.40` (默认端口 80)
*   **数据库**: 自动运行在容器内，数据持久化在 `postgres_data` 卷中。
*   **后端 API**: 内部运行在 3000 端口，通过 Nginx 反向代理访问。

#### 3. 默认管理员账号

系统启动时会自动创建（如果不存在）以下默认账号：

*   **管理员账号**: `admin@gateway.com`
*   **默认密码**: `adminpassword`
*   **普通用户账号**: `user@example.com`
*   **默认密码**: `userpassword`

> **安全提示**: 请登录后立即修改默认密码。

#### 4. 常见维护操作

```bash
# 停止服务
docker-compose down

# 重启后端服务
docker-compose restart backend

# 进入数据库容器
docker exec -it gateway_db psql -U liruoyu -d gateway
```

### 方式二：传统源码交付 (使用 PM2)
*   提供完整的前后端源代码。
*   运维人员需要在服务器上执行 `npm install` 安装依赖，`npm run build` 编译前端，并使用 `pm2` 启动后端。
*   **注意**: 必须手动在服务器安装中文字体库，否则 PDF 报告可能出现乱码。

### 方式三：编译好的安装包
*   提供编译后的后端 `dist` 目录和前端 `dist` 静态文件包。
*   运维人员直接运行 Node 进程和配置 Nginx 即可，无需编译环境。

## 6. 已有域名规划

*   **计划域名**: `xxx.公司域名.com`
*   **SSL 证书**: 建议准备该域名的 SSL 证书 (PEM/KEY 格式)，在 Nginx 中配置 HTTPS 以保证数据安全。

## 7. 部署架构建议

```
用户 -> Nginx (xxx.公司域名.com:443) 
        |
        +--> /api/* -> 后端服务 (localhost:3000) -> PostgreSQL (localhost:5432)
        |
        +--> /*     -> 前端静态资源 (HTML/CSS/JS)
